<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ä½æ‰€æ¤œç´¢ãƒ‡ãƒ¢ - CRM V9</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .container {
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      max-width: 800px;
      width: 100%;
      padding: 40px;
    }

    h1 {
      color: #667eea;
      font-size: 32px;
      margin-bottom: 10px;
      text-align: center;
    }

    .subtitle {
      text-align: center;
      color: #666;
      margin-bottom: 40px;
      font-size: 14px;
    }

    .section {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
      border: 2px solid #e9ecef;
      transition: border-color 0.3s;
    }

    .section:hover {
      border-color: #667eea;
    }

    h2 {
      color: #333;
      font-size: 20px;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
    }

    h2::before {
      content: "ğŸ“";
      margin-right: 8px;
      font-size: 24px;
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      color: #555;
      font-size: 14px;
      margin-bottom: 6px;
      font-weight: 500;
    }

    input[type="text"] {
      width: 100%;
      padding: 12px 16px;
      border: 2px solid #e9ecef;
      border-radius: 8px;
      font-size: 16px;
      transition: all 0.3s;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .input-row {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }

    button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 14px 32px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.3s;
      width: 100%;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .result {
      margin-top: 20px;
      padding: 16px;
      border-radius: 8px;
      display: none;
    }

    .result.success {
      background: #d4edda;
      border: 2px solid #c3e6cb;
      color: #155724;
      display: block;
    }

    .result.error {
      background: #f8d7da;
      border: 2px solid #f5c6cb;
      color: #721c24;
      display: block;
    }

    .result.loading {
      background: #fff3cd;
      border: 2px solid #ffeeba;
      color: #856404;
      display: block;
    }

    .result-title {
      font-weight: bold;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .result-content {
      font-size: 14px;
      line-height: 1.6;
    }

    .address-item {
      padding: 12px;
      background: white;
      border-radius: 6px;
      margin-bottom: 8px;
      border-left: 4px solid #667eea;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .address-item:last-child {
      margin-bottom: 0;
    }

    .spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-radius: 50%;
      border-top-color: white;
      animation: spin 1s ease-in-out infinite;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .example {
      background: #e7f3ff;
      border-left: 4px solid #2196F3;
      padding: 12px;
      margin-top: 12px;
      border-radius: 4px;
      font-size: 13px;
      color: #0d47a1;
    }

    .example strong {
      color: #1565c0;
    }

    @media (max-width: 600px) {
      .container {
        padding: 24px;
      }

      .input-row {
        grid-template-columns: 1fr;
      }

      h1 {
        font-size: 24px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ—ºï¸ ä½æ‰€æ¤œç´¢ãƒ‡ãƒ¢</h1>
    <p class="subtitle">CRM V9 System - åŒæ–¹å‘ä½æ‰€æ¤œç´¢æ©Ÿèƒ½</p>

    <!-- Section 1: Zip Code to Address -->
    <div class="section">
      <h2>éƒµä¾¿ç•ªå·ã‹ã‚‰ä½æ‰€ã‚’æ¤œç´¢</h2>
      <div class="form-group">
        <label for="zipcode">éƒµä¾¿ç•ªå·</label>
        <input
          type="text"
          id="zipcode"
          placeholder="ä¾‹: 100-0005 ã¾ãŸã¯ 1000005"
          maxlength="8"
        >
        <div class="example">
          <strong>ä¾‹:</strong> 100-0005 (æ±äº¬é§…å‘¨è¾º), 060-0000 (æœ­å¹Œå¸‚ä¸­å¤®åŒº), 541-0041 (å¤§é˜ªå¸‚ä¸­å¤®åŒº)
        </div>
      </div>
      <button onclick="lookupAddress()">
        <span id="btn1-spinner"></span>
        <span id="btn1-text">ä½æ‰€ã‚’æ¤œç´¢</span>
      </button>
      <div id="addressResult" class="result"></div>
    </div>

    <!-- Section 2: Address to Zip Code -->
    <div class="section">
      <h2>ä½æ‰€ã‹ã‚‰éƒµä¾¿ç•ªå·ã‚’æ¤œç´¢</h2>
      <div class="input-row">
        <div class="form-group">
          <label for="prefecture">éƒ½é“åºœçœŒ</label>
          <input
            type="text"
            id="prefecture"
            placeholder="æ±äº¬éƒ½"
          >
        </div>
        <div class="form-group">
          <label for="city">å¸‚åŒºç”ºæ‘</label>
          <input
            type="text"
            id="city"
            placeholder="åƒä»£ç”°åŒº"
          >
        </div>
        <div class="form-group">
          <label for="address1">ç”ºåŸŸãƒ»ç•ªåœ°</label>
          <input
            type="text"
            id="address1"
            placeholder="ä¸¸ã®å†…1-9-1"
          >
        </div>
      </div>
      <div class="example">
        <strong>æ³¨æ„:</strong> ç”ºåŸŸãƒ»ç•ªåœ°ã¾ã§å…¥åŠ›ã™ã‚‹ã¨ç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™ã€‚ä¾‹: ä¸¸ã®å†…1-9-1 (æ±äº¬é§…)
      </div>
      <button onclick="lookupZipCode()">
        <span id="btn2-spinner"></span>
        <span id="btn2-text">éƒµä¾¿ç•ªå·ã‚’æ¤œç´¢</span>
      </button>
      <div id="zipcodeResult" class="result"></div>
    </div>
  </div>

  <script>
    // Zip code to address lookup
    function lookupAddress() {
      const zipcode = document.getElementById('zipcode').value.trim();
      const resultDiv = document.getElementById('addressResult');
      const spinner = document.getElementById('btn1-spinner');
      const btnText = document.getElementById('btn1-text');

      if (!zipcode) {
        showResult(resultDiv, 'error', 'ã‚¨ãƒ©ãƒ¼', 'éƒµä¾¿ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // Show loading state
      showResult(resultDiv, 'loading', 'æ¤œç´¢ä¸­...', 'ä½æ‰€ã‚’æ¤œç´¢ã—ã¦ã„ã¾ã™...');
      spinner.innerHTML = '<span class="spinner"></span>';
      btnText.textContent = 'æ¤œç´¢ä¸­...';

      google.script.run
        .withSuccessHandler(function(response) {
          spinner.innerHTML = '';
          btnText.textContent = 'ä½æ‰€ã‚’æ¤œç´¢';
          handleAddressResponse(response, resultDiv);
        })
        .withFailureHandler(function(error) {
          spinner.innerHTML = '';
          btnText.textContent = 'ä½æ‰€ã‚’æ¤œç´¢';
          showResult(resultDiv, 'error', 'ã‚¨ãƒ©ãƒ¼', 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        })
        .api_getAddressByZipCode(zipcode);
    }

    // Address to zip code lookup
    function lookupZipCode() {
      const prefecture = document.getElementById('prefecture').value.trim();
      const city = document.getElementById('city').value.trim();
      const address1 = document.getElementById('address1').value.trim() || null;
      const resultDiv = document.getElementById('zipcodeResult');
      const spinner = document.getElementById('btn2-spinner');
      const btnText = document.getElementById('btn2-text');

      if (!prefecture || !city) {
        showResult(resultDiv, 'error', 'ã‚¨ãƒ©ãƒ¼', 'éƒ½é“åºœçœŒã¨å¸‚åŒºç”ºæ‘ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // Show loading state
      showResult(resultDiv, 'loading', 'æ¤œç´¢ä¸­...', 'éƒµä¾¿ç•ªå·ã‚’æ¤œç´¢ã—ã¦ã„ã¾ã™...');
      spinner.innerHTML = '<span class="spinner"></span>';
      btnText.textContent = 'æ¤œç´¢ä¸­...';

      google.script.run
        .withSuccessHandler(function(response) {
          spinner.innerHTML = '';
          btnText.textContent = 'éƒµä¾¿ç•ªå·ã‚’æ¤œç´¢';
          handleZipCodeResponse(response, resultDiv);
        })
        .withFailureHandler(function(error) {
          spinner.innerHTML = '';
          btnText.textContent = 'éƒµä¾¿ç•ªå·ã‚’æ¤œç´¢';
          showResult(resultDiv, 'error', 'ã‚¨ãƒ©ãƒ¼', 'ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
        })
        .api_getZipCodeByAddress(prefecture, city, address1);
    }

    // Handle address lookup response
    function handleAddressResponse(jsonString, resultDiv) {
      try {
        const response = JSON.parse(jsonString);

        if (response.status === 'success') {
          const addresses = response.data;

          if (addresses.length === 0) {
            showResult(resultDiv, 'error', 'çµæœãªã—', 'è©²å½“ã™ã‚‹ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            return;
          }

          let html = '<div class="result-title">âœ… ' + addresses.length + 'ä»¶ã®ä½æ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</div>';
          html += '<div class="result-content">';

          addresses.forEach((addr, index) => {
            html += '<div class="address-item">';
            html += '<strong>çµæœ ' + (index + 1) + ':</strong><br>';
            html += addr.prefecture + addr.city + addr.address1;
            html += '</div>';
          });

          html += '</div>';

          resultDiv.className = 'result success';
          resultDiv.innerHTML = html;
        } else {
          showResult(resultDiv, 'error', 'ã‚¨ãƒ©ãƒ¼', response.message || 'ä½æ‰€ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      } catch (e) {
        showResult(resultDiv, 'error', 'ã‚¨ãƒ©ãƒ¼', 'ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    }

    // Handle zip code lookup response
    function handleZipCodeResponse(jsonString, resultDiv) {
      try {
        const response = JSON.parse(jsonString);

        if (response.status === 'success') {
          const zipcode = response.data;

          if (!zipcode) {
            showResult(resultDiv, 'error', 'çµæœãªã—', 'è©²å½“ã™ã‚‹éƒµä¾¿ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚');
            return;
          }

          const formatted = zipcode.substring(0, 3) + '-' + zipcode.substring(3);

          let html = '<div class="result-title">âœ… éƒµä¾¿ç•ªå·ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ</div>';
          html += '<div class="result-content">';
          html += '<div class="address-item">';
          html += '<strong>éƒµä¾¿ç•ªå·:</strong> ' + formatted + ' (' + zipcode + ')';
          html += '</div>';
          html += '</div>';

          resultDiv.className = 'result success';
          resultDiv.innerHTML = html;
        } else {
          showResult(resultDiv, 'error', 'ã‚¨ãƒ©ãƒ¼', response.message || 'éƒµä¾¿ç•ªå·ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }
      } catch (e) {
        showResult(resultDiv, 'error', 'ã‚¨ãƒ©ãƒ¼', 'ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®è§£æã«å¤±æ•—ã—ã¾ã—ãŸ: ' + e.message);
      }
    }

    // Show result helper
    function showResult(resultDiv, type, title, message) {
      let icon = '';
      switch(type) {
        case 'success': icon = 'âœ…'; break;
        case 'error': icon = 'âŒ'; break;
        case 'loading': icon = 'â³'; break;
      }

      resultDiv.className = 'result ' + type;
      resultDiv.innerHTML =
        '<div class="result-title">' + icon + ' ' + title + '</div>' +
        '<div class="result-content">' + message + '</div>';
    }

    // Enter key support
    document.getElementById('zipcode').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') lookupAddress();
    });

    document.getElementById('address1').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') lookupZipCode();
    });
  </script>
</body>
</html>
