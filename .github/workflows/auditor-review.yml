name: Auditor Review (ChatGPT)

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  auditor-review:
    # トリガー条件: Issue/PR コメントに "@auditor review" が含まれる
    if: contains(github.event.comment.body, '@auditor review')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref || github.ref }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract review request
        id: extract
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body;
            
            // コメントから情報を抽出
            const taskNameMatch = comment.match(/タスク名[:\s]+(.+)/);
            const implementationMatch = comment.match(/実施内容[:\s]+([\s\S]+?)(?=変更ファイル|$)/);
            const filesMatch = comment.match(/変更ファイル[:\s]+([\s\S]+?)(?=テスト結果|$)/);
            const testResultsMatch = comment.match(/テスト結果[:\s]+([\s\S]+?)(?=@auditor|$)/);
            
            const reviewRequest = {
              taskName: taskNameMatch ? taskNameMatch[1].trim() : 'Unknown Task',
              implementation: implementationMatch ? implementationMatch[1].trim() : 'No details provided',
              changedFiles: filesMatch ? filesMatch[1].trim() : 'No files listed',
              testResults: testResultsMatch ? testResultsMatch[1].trim() : 'No test results'
            };
            
            core.setOutput('taskName', reviewRequest.taskName);
            core.setOutput('implementation', reviewRequest.implementation);
            core.setOutput('changedFiles', reviewRequest.changedFiles);
            core.setOutput('testResults', reviewRequest.testResults);

      - name: Call ChatGPT API for review
        id: chatgpt
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          # ChatGPT API を呼び出してレビューを実施
          RESPONSE=$(curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d '{
              "model": "gpt-4",
              "messages": [
                {
                  "role": "system",
                  "content": "あなたは CRM V10 プロジェクトの Auditor (Strict Judge) です。コードレビューを実施し、Approve/Reject を判定してください。PROJECT_MANIFEST.md と HANDOVER_DOCUMENT.md のルールに準拠しているか確認してください。"
                },
                {
                  "role": "user",
                  "content": "# Auditor レビュー依頼\n\n## 成果物\n\n### タスク名\n${{ steps.extract.outputs.taskName }}\n\n### 実施内容\n${{ steps.extract.outputs.implementation }}\n\n### 変更ファイル\n${{ steps.extract.outputs.changedFiles }}\n\n### テスト結果\n${{ steps.extract.outputs.testResults }}\n\n## レビュー基準\n\n1. **ルール準拠**\n   - PROJECT_MANIFEST.md のルールに準拠しているか\n   - Git Worktree Isolation Protocol を守っているか\n\n2. **品質**\n   - ビルドエラーがないか\n   - TypeScript の型エラーがないか\n   - セキュリティ上の問題がないか\n\n3. **ドキュメント**\n   - CURRENT_STATUS.md が更新されているか\n   - Changelog に変更内容が記載されているか\n\n4. **動作確認**\n   - デプロイが成功しているか\n   - 動作確認が実施されているか\n\n## 判定フォーマット\n\n以下の形式で回答してください:\n\n**判定:** [✅ Approve / ❌ Reject]\n\n**評価:**\n- ルール準拠: [✅/❌]\n- 品質: [✅/❌]\n- ドキュメント: [✅/❌]\n- 動作確認: [✅/❌]\n\n**理由:**\n- [理由1]\n- [理由2]\n\n**改善提案 (Reject の場合のみ):**\n- [提案1]\n- [提案2]\n\n**次のアクション:**\n[Approve の場合: Git Commit & Push を実行]\n[Reject の場合: 修正後に再提出]"
                }
              ],
              "temperature": 0.3,
              "max_tokens": 2000
            }')
          
          # レスポンスから判定結果を抽出
          REVIEW_RESULT=$(echo $RESPONSE | jq -r '.choices[0].message.content')
          
          # 判定結果を出力変数に設定
          echo "review_result<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW_RESULT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Approve/Reject を判定
          if echo "$REVIEW_RESULT" | grep -q "✅ Approve"; then
            echo "decision=approve" >> $GITHUB_OUTPUT
          else
            echo "decision=reject" >> $GITHUB_OUTPUT
          fi

      - name: Post review result as comment
        uses: actions/github-script@v7
        with:
          script: |
            const reviewResult = `${{ steps.chatgpt.outputs.review_result }}`;
            const decision = '${{ steps.chatgpt.outputs.decision }}';
            
            const emoji = decision === 'approve' ? '✅' : '❌';
            const label = decision === 'approve' ? 'approved' : 'changes-requested';
            
            // コメントを投稿
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ${emoji} Auditor Review Result\n\n${reviewResult}\n\n---\n*Automated review by ChatGPT Auditor*`
            });
            
            // PR の場合はラベルを追加
            if (context.payload.issue.pull_request) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [label]
              });
            }

      - name: Approve PR (if approved)
        if: steps.chatgpt.outputs.decision == 'approve' && github.event.issue.pull_request
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'APPROVE',
              body: '✅ Auditor による自動承認: 品質基準を満たしています。Git Commit & Push を実行してください。'
            });

      - name: Request changes (if rejected)
        if: steps.chatgpt.outputs.decision == 'reject' && github.event.issue.pull_request
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
              event: 'REQUEST_CHANGES',
              body: '❌ Auditor による変更要求: 上記の指摘事項を修正してください。'
            });
